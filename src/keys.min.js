(function(g,k,t){"object"===typeof exports?exports=k(exports,"undefined"!==typeof window?window:"undefined"!==typeof global?global:{}):"function"===typeof define?define(function(){return k({},g)}):g=k(g,window)})(this,function(g,k,t){function u(a,c,b){(!b||g.debug)&&a.slice().forEach(function(a){c.call(null,a)});return a}function v(a){var c=Array.prototype.slice.call(arguments,1);return a.map(function(a,b){for(var l=[],f=0;f<c.length;f++){var e=c[f]&&c[f][b];l.push(null!==e&&"undefined"!==typeof e?
e:null)}return[a].concat(l)})}function n(a,c){for(var b=0;b<a.length;b++)if(c(a[b]))return a[b];return null}function b(a,c){this.name=a;this.code=c;b.internals.keymap[a]=b.internals.keymap[a]||c}function e(a,c){function h(a,c){return null!==n(a,function(a){return c.eq(a)})}var d=null;if(2===arguments.length&&c instanceof Array)d=c;else if(2<=arguments.length)d=Array.prototype.slice.call(arguments,1);else{if(1===arguments.length){this.key=a;this.ctrl=a.eq(b.CTRL);this.shift=a.eq(b.SHIFT);this.alt=
a.eq(b.ALT);this.meta=a.eq(b.META)||a.eq(b.META_RIGHT);return}throw Error("Combo: Invalid number of arguments provided.");}if(n(d,function(a){switch(a.code){case b.CTRL.code:case b.SHIFT.code:case b.ALT.code:case b.META.code:case b.META_RIGHT.code:return!1;default:return!0}}))throw Error("Combo: Attempted to create a Combo with multiple non-meta Keys. This is not supported.");this.key=a;this.ctrl=h(d,b.CTRL)||a.eq(b.CTRL);this.shift=h(d,b.SHIFT)||a.eq(b.SHIFT);this.alt=h(d,b.ALT)||a.eq(b.ALT);this.meta=
(this.meta=h(d,b.META)||h(d,b.META_RIGHT))||a.eq(b.META)||a.eq(b.META_RIGHT)}function q(a){if(!a||!(a instanceof Array))a=[!1,!1,!1,!1];return v(b.metaKeys,a).filter(function(a){return!0===a[1]}).map(function(a){return a[0]})}function m(){function a(a){"undefined"!==typeof a.stopImmediatePropagation?a.stopImmediatePropagation():a.cancelBubble=!0;var b=e.fromEvent(a);if(b)return u(c.getHandlersForCombo(b).filter(function(c){return c.eventType===a.type}),function(a){p("Bindings.handleEvent called for Combo: "+
b.toString()+". Handler `"+a.name+"` was called.")},!0).forEach(function(a){a.handler.call(null)}),!1}var c=this;"undefined"!==typeof k.document.addEventListener?(k.document.addEventListener("keydown",a,!0),k.document.addEventListener("keyup",a,!0),k.document.addEventListener("keypress",a,!0)):(k.document.attachEvent("onkeydown",a),k.document.attachEvent("onkeyup",a),k.document.attachEvent("onkeypress",a));this.bindings=[];this.handlers=[]}g=g||{};g.debug=!1;Function.prototype.bind||(Function.prototype.bind=
function(a){var c=this;return function(){var b=Array.prototype.slice.call(arguments);return c.apply(a,b)}});var s=Function.prototype.bind,p=function(){var a=console?s.call(console.log,console):Function.prototype.valueOf();return function(){if(g.debug){var c=Array.prototype.slice.call(arguments);a.apply(null,c)}}}(),w=function(){var a=console?s.call(console.warn,console):Function.prototype.valueOf();return function(){var c=Array.prototype.slice.call(arguments);a.apply(null,c)}}();Array.prototype.forEach||
(Array.prototype.forEach=function(a,c){if(!this)throw Error("forEach: Array is null or undefined.");if("function"!==typeof a)throw Error("forEach: Iterator is not callable.");var b=this.length>>>0,d=0;for(c=c||null;d<b;)Object.prototype.hasOwnProperty.call(this,d)&&a.call(c,this[d],d,this),d++});Array.prototype.map||(Array.prototype.map=function(a){var c=[];this.forEach(function(b,d,e){c.push(a.call(null,b,d,e))});return c});Array.prototype.filter||(Array.prototype.filter=function(a,c){if("function"!==
typeof a)throw Error("Predicate is not callable.");var b=[];this.forEach(function(d,e,f){a.call(c,d,e,f)&&b.push(d)});return b});Array.prototype.indexOf||(Array.prototype.indexOf=function(a){if(null===this)throw new TypeError;var c=Object(this),b=c.length>>>0;if(0===b)return-1;var d=0;0<arguments.length&&(d=Number(arguments[1]),d!=d?d=0:0!==d&&(Infinity!=d&&-Infinity!=d)&&(d=(0<d||-1)*Math.floor(Math.abs(d))));if(d>=b)return-1;for(d=0<=d?d:Math.max(b-Math.abs(d),0);d<b;d++)if(d in c&&c[d]===a)return d;
return-1});b.internals={};b.internals.keymap={A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,"Numpad 0":96,"Numpad 1":97,"Numpad 2":98,"Numpad 3":99,"Numpad 4":100,"Numpad 5":101,"Numpad 6":102,"Numpad 7":103,"Numpad 8":104,"Numpad 9":105,Multiply:106,Add:107,Subtract:109,Decimal:110,Divide:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F11:122,F12:123,
F13:124,F14:125,F15:126,Backspace:8,Tab:9,Enter:13,SHIFT:16,CTRL:17,ALT:18,META:91,META_RIGHT:93,"Caps Lock":20,Esc:27,Spacebar:32,"Page Up":33,"Page Down":34,End:35,Home:36,Left:37,Up:38,Right:39,Down:40,Insert:45,Delete:46,"Num Lock":144,ScrLk:145,"Pause/Break":19,"; :":186,"= +":187,",":188,"- _":189,".":190,"/ ?":191,"` ~":192,"[ {":219,"\\ |":220,"] }":221,"\" '":222};for(var r in b.internals.keymap)b[r]=new b(r,b.internals.keymap[r]);b.metaKeys=[b.CTRL,b.ALT,b.SHIFT,b.META];b.fromName=function(a){return(a=
b[a])&&a instanceof b?a:null};b.fromCode=function(a){for(var c in b.internals.keymap)if(b.internals.keymap[c]===a)return b[c];return null};b.fromEvent=function(a){return b.fromCode(a.which)};b.prototype.isPressed=function(a){return this.code===a};b.prototype.isMeta=function(){switch(this.code){case b.CTRL.code:case b.SHIFT.code:case b.ALT.code:case b.META.code:case b.META_RIGHT.code:return!0;default:return!1}};b.prototype.eq=function(a){return this.code===a.code&&this.name===a.name};g.Key=b;e.prototype.toString=
function(){var a=(this.ctrl?"CTRL+":"")+(this.alt?"ALT+":"")+(this.shift?"SHIFT+":"")+(this.meta?"META+":"");if(this.key.isMeta()){var c;c=a.length-1===a.lastIndexOf("+")?!0:!1;return c?a.slice(0,a.length-1):a}return a+(this.key&&this.key.name?this.key.name:"")};e.prototype.serialize=function(){if("undefined"===typeof JSON)throw Error("Your browser does not currently support JSON serialization.");return JSON.stringify(this)};e.deserialize=function(a){if("undefined"===typeof JSON)throw Error("Your browser does not currently support JSON deserialization.");
if(!a)return null;a=JSON.parse(a);return e.fromObject(a)};e.prototype.clone=function(){return e.fromObject({key:this.key,ctrl:this.ctrl,alt:this.alt,shift:this.shift,meta:this.meta})};e.fromObject=function(a){if(!a||!a.key||!a.key.name||!a.key.code)throw Error("Combo.fromObject: Invalid Combo object provided.");var c=new b(a.key.name,a.key.code);a=q([a.ctrl,a.alt,a.shift,a.meta]);return a.length?new e(c,a):new e(c)};e.fromEvent=function(a){if(!a||!a.which&&!a.keyCode)return null;var c=b.fromCode(a.which||
a.keyCode);if(!c)return null;a=q([a.ctrlKey,a.altKey,a.shiftKey,a.metaKey]);return a.length?new e(c,a):new e(c)};e.fromString=function(a){var c=a.split("+").filter(function(a){return!a?!1:!0});a=b.fromName(c.length?c[c.length-1]:c[0]);if(c.length){if(1<c.length){var h=-1<c.indexOf("CTRL"),d=-1<c.indexOf("ALT"),l=-1<c.indexOf("SHIFT"),c=-1<c.indexOf("META")||-1<c.indexOf("META_RIGHT"),h=q([h,d,l,c]);if(a&&h.length)return new e(a,h);throw Error("Combo.fromString: Invalid Combo string, more than one non-meta key was specified.");
}if(a)return new e(a)}throw Error("Combo.fromString: Invalid Combo string.");};e.prototype.eq=function(a){return!a||!(a instanceof e)?!1:this.key.eq(a.key)?this.shift!==a.shift?!1:this.alt!==a.alt?!1:this.ctrl!==a.ctrl?!1:this.meta!==a.meta?!1:!0:!1};e.prototype.isMatch=function(a){if(!a&&!(a instanceof e))throw Error("Combo.isMatch called with an invalid Combo object.");if(this.key.isMeta()){if((this.shift||this.key.eq(b.SHIFT))!==a.shift||(this.alt||this.key.eq(b.ALT))!==a.alt||(this.ctrl||this.key.eq(b.CTRL))!==
a.ctrl||(this.meta||this.key.eq(b.META)||this.key.eq(b.META_RIGHT))!==a.meta)return!1}else return this.eq(a);return!0};e.prototype.metaKeys=function(){var a=[this.ctrl||this.key.eq(b.CTRL),this.alt||this.key.eq(b.ALT),this.shift||this.key.eq(b.SHIFT),this.meta||this.key.eq(b.META)||this.key.eq(b.META_RIGHT)];return q(a)};g.Combo=e;m.prototype.get=function(a){return n(this.bindings,function(c){return c.name===a})};m.prototype.add=function(a){var c=Array.prototype.slice.call(arguments,1);if(2>arguments.length||
!a||!c.length)throw Error("Keybindings.add: Invalid arguments provided");c.forEach(function(a){if(!(a instanceof e||a instanceof b))throw Error("Keybindings.add: `combo` must be an instance of Key or Combo");});var h=n(this.bindings,function(c){return c.name===a});h?(h.combos=c,p("Bindings.add: Updated existing binding - `"+a+"` with "+c.length+" combos")):(this.bindings.push({name:a,combos:c}),p("Bindings.add: New binding - `"+a+"` with "+c.length+" combos"))};m.prototype.registerHandler=function(a,
c,b){1===arguments.length&&"function"===typeof a?(b=a,a=b.name,c="keydown"):2===arguments.length&&"function"===typeof c&&("keyup"===a||"keydown"===a||"keypress"===a?(b=c,c=a,a=b.name):(b=c,c="keydown"));if(!a||!c||!b||"function"!==typeof b)throw Error("Bindings.registerHandler: Invalid arguments provided");if("anonymous"===a)throw Error("Bindings.registerHandler: The function handler provided was anonymous when it needs to be named (in order to infer the binding name)");this.get(a)||w("Bindings.registerHandler: You have registered a handler for `"+
a+"`, but that binding as not yet been added.");this.handlers.push({name:a,eventType:c,handler:b});p("Bindings.registerHandler: Handler `"+a+"` registered for `"+c+"` events.")};m.prototype.registerHandlers=function(a,b){var e=this;if(2<arguments.length||0===arguments.length)throw Error("Bindings.registerHandlers: Bad invocation. Incorrect # of arguments provided.");if(2===arguments.length&&"string"!==typeof b)throw Error("Bindings.registerHandlers: Bad invocation. eventType must be a string (keyup|keydown).");
if(a instanceof Array)a.forEach(function(a){if(!a.name||"anonymous"===a.name)throw Error("Bindings.registerHandlers: Array notation with anonymous functions is not allowed.");b?e.registerHandler(b,a):e.registerHandler(a)});else if("object"===typeof a)for(var d in a)if(a.hasOwnProperty(d)){var l=d,f=a[d];if("function"===typeof f)e.registerHandler(l,f);else if("object"===typeof f){var g=f.eventType||b,f=f.handler;if(!f||"function"!==typeof f)throw Error("Bindings.registerHandlers: Invalid handler specification, must define the handler property as a function.");
g?e.registerHandler(l,g,f):e.registerHandler(l,f)}}};m.prototype.registerToggle=function(a,b,e){if(3!==arguments.length)throw Error("Keybindings.registerToggle: You must provide all three arguments to this function.");this.handlers.push({name:a,eventType:"keydown",handler:function(){var a=!1;return function(){var l=Array.prototype.slice.call(arguments);a?(a=!1,e.apply(null,l)):(a=!0,b.apply(null,l))}}()});p("Bindings.registerToggle: Toggle `"+a+"` registered.")};m.prototype.serialize=function(){if("undefined"===
typeof JSON)throw Error("Your browser does not support JSON serialization.");return JSON.stringify(this)};m.prototype.deserialize=function(a){if("undefined"===typeof JSON)throw Error("Your browser does not support JSON serialization.");a=JSON.parse(a);if(!a||!a.bindings||a instanceof Array)throw Error("Keybindings.deserialize: Unable to deserialize keybindings");this.bindings=a.bindings.map(function(a){a.combos=a.combos.map(function(a){return"undefined"!==typeof a.code?new b(a.name,a.code):e.fromObject(a)});
return a})};m.prototype.getHandlersForCombo=function(a){function c(a,b){for(var c=0;c<a.length;c++)if(b(a[c]))return!0;return!1}var e=this.bindings.filter(function(d){return c(d.combos,function(c){return c instanceof b?a.key.eq(c):c.isMatch(a)})});return this.handlers.filter(function(a){return n(e,function(b){return b.name===a.name})})};g.Bindings=m;return g});
